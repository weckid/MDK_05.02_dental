{% extends 'base.html' %}
{% load static %}

{% block title %}RX - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<!-- –ì–µ—Ä–æ–π —Å–µ–∫—Ü–∏—è -->
<section class="profile-hero">
    <div class="container">
        <h1 class="fade-in-up">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>
        <p class="fade-in-up">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–∞—à–µ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –∏—Å—Ç–æ—Ä–∏–µ–π –∑–∞–ø–∏—Å–µ–π</p>
    </div>
</section>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è -->
<section class="profile-section">
    <div class="container">
        <div class="profile-container">
            <div class="profile-card fade-in-up">
                <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
                <form method="post" enctype="multipart/form-data" class="profile-form">
                    {% csrf_token %}

                    <div class="profile-content">
                        <!-- –ê–≤–∞—Ç–∞—Ä –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="profile-avatar">
                            <div class="avatar-container">
                                <img src="{% if user.userprofile.avatar %}{{ user.userprofile.avatar.url }}{% else %}{% static 'img/profile.jpg' %}{% endif %}"
                                     alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" class="avatar-image" id="avatarPreview">
                                <div class="avatar-overlay">
                                    <span class="avatar-text">üì∑</span>
                                </div>
                            </div>
                            <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;">
                            <button type="button" class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
                                –°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ
                            </button>
                            {% if user.userprofile.avatar %}
                            <button type="button" class="avatar-remove" onclick="removeAvatar()">
                                –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ
                            </button>
                            {% endif %}
                        </div>

                        <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="profile-info">
                            <div class="form-group">
                                <label for="id_first_name" class="info-label">üë§ –ò–º—è *</label>
                                <input type="text" name="first_name" id="id_first_name"
                                       value="{{ user.first_name|default:'' }}"
                                       class="profile-input" required>
                            </div>

                            <div class="form-group">
                                <label for="id_last_name" class="info-label">üë• –§–∞–º–∏–ª–∏—è *</label>
                                <input type="text" name="last_name" id="id_last_name"
                                       value="{{ user.last_name|default:'' }}"
                                       class="profile-input" required>
                            </div>

                            <div class="form-group">
                                <label for="id_email" class="info-label">üìß Email *</label>
                                <input type="email" name="email" id="id_email"
                                       value="{{ user.email|default:'' }}"
                                       class="profile-input" required>
                            </div>

                            <div class="form-group">
                                <label for="id_phone" class="info-label">üìû –¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" name="phone" id="id_phone"
                                       value="{{ user.userprofile.phone|default:'' }}"
                                       class="profile-input"
                                       placeholder="+7 (999) 999-99-99">
                            </div>

                            <div class="form-group">
                                <label for="id_birth_date" class="info-label">üéÇ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                                <input type="date" name="birth_date" id="id_birth_date"
                                       value="{{ user.userprofile.birth_date|date:'Y-m-d'|default:'' }}"
                                       class="profile-input">
                            </div>

                            <div class="form-group">
                                <label for="id_city" class="info-label">üèôÔ∏è –ì–æ—Ä–æ–¥</label>
                                <input type="text" name="city" id="id_city"
                                       value="{{ user.userprofile.city|default:'' }}"
                                       class="profile-input"
                                       placeholder="–í–∞—à –≥–æ—Ä–æ–¥">
                            </div>

                            <div class="form-group">
                                <label for="id_address" class="info-label">üìç –ê–¥—Ä–µ—Å</label>
                                <textarea name="address" id="id_address"
                                          class="profile-input profile-textarea"
                                          placeholder="–í–∞—à –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å">{{ user.userprofile.address|default:'' }}</textarea>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="profile-save-btn">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                </button>
                                <a href="{% url 'profile' %}" class="profile-cancel-btn">
                                    ‚ùå –û—Ç–º–µ–Ω–∞
                                </a>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø–∏—Å–µ–π -->
                <div class="appointments-section">
                    <h3 class="section-title">üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏ –Ω–∞ –ø—Ä–∏–µ–º</h3>

                    {% if appointments %}
                    <div class="appointments-list">
                        {% for appointment in appointments %}
                        <div class="appointment-card">
                            <div class="appointment-header">
                                <span class="appointment-service">{{ appointment.service.name }}</span>
                                <span class="appointment-status status-{{ appointment.status }}">
                                    {{ appointment.get_status_display }}
                                </span>
                            </div>
                            <div class="appointment-details">
                                <div>
                                    <strong>üë®‚Äç‚öïÔ∏è –í—Ä–∞—á:</strong><br>
                                    {{ appointment.doctor.user.get_full_name }}
                                </div>
                                <div>
                                    <strong>üìÖ –î–∞—Ç–∞:</strong><br>
                                    {{ appointment.appointment_date|date:"d.m.Y H:i" }}
                                </div>
                                <div>
                                    <strong>üè• –ö–ª–∏–Ω–∏–∫–∞:</strong><br>
                                    {{ appointment.clinic.name }}
                                </div>
                            </div>
                            {% if appointment.notes %}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                                <strong>üí¨ –ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</strong><br>
                                {{ appointment.notes }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 3rem; color: var(--text-light);">
                        <p style="font-size: 1.2rem; margin-bottom: 1rem;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ –ø—Ä–∏–µ–º</p>
                        <a href="{% url 'catalog' %}" class="service-btn primary" style="display: inline-block;">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–æ—Ñ–∏–ª—è */
.profile-form .form-group {
    margin-bottom: 1.5rem;
}

.profile-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    transition: var(--transition);
    background: var(--white);
}

.profile-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}

.profile-textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
}

.avatar-container {
    position: relative;
    display: inline-block;
    cursor: pointer;
}

.avatar-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: var(--transition);
}

.avatar-container:hover .avatar-overlay {
    opacity: 1;
}

.avatar-text {
    color: white;
    font-size: 1.5rem;
}

.avatar-remove {
    background: #ef4444;
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: var(--radius);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    margin-top: 0.5rem;
    width: 100%;
}

.avatar-remove:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
}

.profile-save-btn {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 1rem 2rem;
    border: none;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    flex: 1;
}

.profile-save-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.profile-cancel-btn {
    background: var(--text-light);
    color: white;
    padding: 1rem 2rem;
    border-radius: var(--radius);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
    text-align: center;
    flex: 1;
}

.profile-cancel-btn:hover {
    background: #6b7280;
    transform: translateY(-2px);
    color: white;
}
</style>

<script>
// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞
document.getElementById('avatarInput').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatarPreview').src = e.target.result;
        }
        reader.readAsDataURL(e.target.files[0]);
    }
});

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
function removeAvatar() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è?')) {
        document.getElementById('avatarPreview').src = '{% static "img/profile.jpg" %}';
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
    }
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞
document.getElementById('avatarInput').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∞–π–ª–∞
        setTimeout(() => {
            document.querySelector('.profile-form').submit();
        }, 100);
    }
});
</script>
{% endblock %}